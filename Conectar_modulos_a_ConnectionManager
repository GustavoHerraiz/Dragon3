# C贸mo conectar con ConnectionManager todos los m贸dulos

> **NOTA IMPORTANTE:**  
> Todo el c贸digo y los ejemplos de este informe asumen SIEMPRE el uso de **ES modules** (`import/export`).  
> No est谩 permitido el uso de CommonJS (`require`, `module.exports`) en ning煤n m贸dulo de Dragon3.

---

## RESUMEN RPIDO PARA DUMMIES 

1. **Crea el cliente Redis con ES Modules.**
2. **Ponle el `serviceName` y la `priority` adecuados.**
3. **Reg铆stralo en `ConnectionManager` usando el nombre del m贸dulo como CLIENT_ID.**
4. **Para cualquier operaci贸n Redis, obt茅n SIEMPRE el cliente con `connectionManager.getRawClientById(CLIENT_ID)`.**
5. **No uses nunca m谩s la instancia directa de Redis.**
6. **Todos los m贸dulos deben seguir esta convenci贸n cambiando s贸lo el CLIENT_ID y el nivel de prioridad.**

---

### TABLA DE REFERENCIA DE CLIENT_ID Y PRIORIDAD

| M贸dulo (archivo)         | CLIENT_ID              | Prioridad recomendada              |
|--------------------------|------------------------|------------------------------------|
| analizadorImagen.js      | "analizadorImagen"     | SERVICE_PRIORITIES.CRITICAL        |
| servidorCentral.js       | "servidorCentral"      | SERVICE_PRIORITIES.HIGH            |
| gestorNotificaciones.js  | "gestorNotificaciones" | SERVICE_PRIORITIES.MEDIUM          |
| logger.js                | "logger"               | SERVICE_PRIORITIES.LOW             |
| ...                      | ...                    | ...                                |

> Usa SIEMPRE el nombre del m贸dulo (sin extensi贸n) como CLIENT_ID para registrar y recuperar el cliente Redis.  
> Elige la prioridad en funci贸n de la criticidad del m贸dulo para el sistema.

---

## 1. Descripci贸n exacta del problema

Actualmente, cada m贸dulo crea y gestiona su propia conexi贸n Redis directamente, sin utilizar el gestor centralizado `ConnectionManager.js`.  
Esto provoca:

- **Falta de control centralizado** de las conexiones Redis.
- **Dif铆cil monitorizaci贸n, logging y priorizaci贸n** de clientes Redis.
- **Riesgo de m煤ltiples conexiones paralelas y fugas de recursos.**
- **Imposibilidad de aplicar pol铆ticas globales** (reconexi贸n, healthcheck, fallback, etc.).
- **Inconsistencia** con la arquitectura deseada del backend Dragon3.

---

## 2. Objetivo

Asegurar que **todas las operaciones Redis en todos los m贸dulos se gestionen a trav茅s de `ConnectionManager.js`**.  
Se proporciona un ejemplo completo usando `analizadorImagen.js` como plantilla para migrar el resto de m贸dulos consumidores Redis en Dragon3.

---

## 3. Pasos para la migraci贸n (paso a paso, ES Modules)

### Paso 1: Localiza la inicializaci贸n directa del cliente Redis

Busca l铆neas como:
```js
const redisClient = new Redis(...opciones...);
```
o cualquier inicializaci贸n de cliente Redis.

**C贸mo buscar con grep (evitando node_modules):**
```sh
grep -rnw . -e 'new Redis' --exclude-dir=node_modules
```
o para cualquier uso de `redisClient`:
```sh
grep -rnw . -e 'redisClient' --exclude-dir=node_modules
```

---

### Paso 2: Importa correctamente `ConnectionManager.js` y los enums de prioridad (**con ES Modules**)

```js
import connectionManager from '../../utilidades/redis/core/ConnectionManager.js';
import { SERVICE_PRIORITIES } from '../../utilidades/redis/core/constants.js'; // Ajusta la ruta seg煤n tu estructura
```

---

### Paso 3: Crea el cliente Redis (siempre con ES modules)

```js
import Redis from 'ioredis';

const redisClient = new Redis(/* tus opciones de conexi贸n */);
```

---

### Paso 4: Asigna metadatos al cliente antes de registrarlo (**DETALLE CRTICO**)

```js
redisClient.serviceName = 'analizadorImagen';
redisClient.priority = SERVICE_PRIORITIES.CRITICAL;
```
> **El `CLIENT_ID` ser谩 siempre el nombre del m贸dulo, por convenci贸n y en min煤scula.**  
> Ejemplo para este m贸dulo:  
> `const ANALIZADOR_REDIS_CLIENT_ID = 'analizadorImagen';`
> Para otros m贸dulos, por ejemplo:  
> `const SERVIDOR_CENTRAL_REDIS_CLIENT_ID = 'servidorCentral';`

---

### Paso 5: Registra el cliente en el ConnectionManager

```js
const ANALIZADOR_REDIS_CLIENT_ID = 'analizadorImagen';
connectionManager.registerClient(ANALIZADOR_REDIS_CLIENT_ID, redisClient);
```

---

### Paso 6: Busca y sustituye todos los usos de la instancia local de Redis

**C贸mo buscar con grep (evitando node_modules):**
```sh
grep -rnw . -e 'redisClient' --exclude-dir=node_modules
```
Sustituye todos los usos de `redisClient` (excepto la inicializaci贸n y registro) por el cliente obtenido a trav茅s del ConnectionManager:

```js
const rawClient = connectionManager.getRawClientById(ANALIZADOR_REDIS_CLIENT_ID);
```

**Ejemplo concreto para analizadorImagen.js:**

ANTES:
```js
await redisClient.xadd(...);
const result = await redisClient.get(...);
```
DESPUS:
```js
const rawClient = connectionManager.getRawClientById('analizadorImagen');
await rawClient.xadd(...);
const result = await rawClient.get(...);
```
> **NOTA:** El CLIENT_ID de cada m贸dulo debe ser el nombre del propio m贸dulo.  
> Por ejemplo, para `analizadorImagen.js` ser谩 siempre `'analizadorImagen'`.

---

### Paso 7: Arranca el consumidor solo si el cliente existe

```js
const rawClient = connectionManager.getRawClientById(ANALIZADOR_REDIS_CLIENT_ID);
if (rawClient) {
  consumirPendientesDragon3(rawClient, analizarImagen);
} else {
  dragon.agoniza(
    'No se pudo obtener el cliente Redis real para el consumidor de im谩genes',
    {},
    'analizadorImagen',
    'CLIENTE_REDIS_NO_ENCONTRADO',
    { clientId: ANALIZADOR_REDIS_CLIENT_ID }
  );
}
```

---

### Paso 8: A帽ade listeners de error y logging robusto

```js
redisClient.on('error', (err) => {
  dragon.agoniza(
    'Error de conexi贸n con Redis',
    { error: err.message },
    'analizadorImagen',
    'REDIS_CONNECTION_ERROR'
  );
});
```

---

### Paso 9: Documenta el cambio en el propio archivo y en la documentaci贸n del proyecto

Incluye comentarios claros sobre el nuevo flujo y la necesidad de pasar SIEMPRE por el `ConnectionManager`.

---

## 4. Resultado esperado

- **Conexi贸n Redis centralizada y controlada**.
- **Facilidad para migrar otros m贸dulos** siguiendo el mismo patr贸n.
- **Mejor trazabilidad y debugging**.
- **Menor riesgo de bugs y fugas de recursos**.

---

## 5. Checklist de verificaci贸n

- [ ] El cliente Redis se registra solo una vez en el ConnectionManager.
- [ ] Todas las operaciones Redis usan el cliente obtenido por ConnectionManager.
- [ ] El logging refleja correctamente el serviceName y los errores.
- [ ] No queda ning煤n uso directo de la instancia local de Redis.
- [ ] El shutdown y fallback funcionan correctamente si Redis falla.
- [ ] El c贸digo est谩 documentado y es entendible para otros desarrolladores.

---

## 6. Ejemplo ES Modules de adaptaci贸n final para `analizadorImagen.js` (plantilla para otros m贸dulos)

```js
// ES Modules SIEMPRE
import dragon from "../../utilidades/logger.js";
import Redis from 'ioredis';
import connectionManager from '../../utilidades/redis/core/ConnectionManager.js';
import { SERVICE_PRIORITIES } from '../../utilidades/redis/core/constants.js';

const ANALIZADOR_REDIS_CLIENT_ID = 'analizadorImagen';
const redisClient = new Redis(/* opciones de conexi贸n */);

redisClient.serviceName = 'analizadorImagen';
redisClient.priority = SERVICE_PRIORITIES.CRITICAL;

connectionManager.registerClient(ANALIZADOR_REDIS_CLIENT_ID, redisClient);

redisClient.on('error', (err) => {
  dragon.agoniza('Error de conexi贸n con Redis', { error: err.message }, 'analizadorImagen', 'REDIS_CONNECTION_ERROR');
});

// Siempre utiliza el cliente de ConnectionManager:
const rawClient = connectionManager.getRawClientById(ANALIZADOR_REDIS_CLIENT_ID);
if (rawClient) {
  consumirPendientesDragon3(rawClient, analizarImagen);
} else {
  dragon.agoniza(
    'No se pudo obtener el cliente Redis real para el consumidor de im谩genes',
    {},
    'analizadorImagen',
    'CLIENTE_REDIS_NO_ENCONTRADO',
    { clientId: ANALIZADOR_REDIS_CLIENT_ID }
  );
}
```

---

## 7. Plan detallado y exacto de migraci贸n para cualquier m贸dulo

_Seguir todos los pasos anteriores, usando siempre ES modules y convenciones de nombrado CLIENT_ID como el nombre del m贸dulo._

---

## 8. Resumen de cambios esperados

- **El acceso a Redis es SIEMPRE a trav茅s de ConnectionManager.**
- **Nunca importar ni usar directamente la instancia de Redis tras la migraci贸n.**
- **Todos los logs de Redis reflejan el `serviceName` y la prioridad.**
- **El c贸digo queda preparado para migrar otros m贸dulos siguiendo el mismo patr贸n, permitiendo orquestaci贸n, health checks y shutdown controlado de Redis.**
- **El `CLIENT_ID` ser谩 siempre el nombre del m贸dulo.**
- **TODO ES modules.**

---

**Este informe sirve de plantilla para migrar el resto de m贸dulos consumidores de Redis en Dragon3. Usa siempre grep para localizar referencias y evitar node_modules.**